var cSettings = require('cSettings');
var db = require('mongoskin').db(cSettings.db.mongolab.url);


exports.route = [
{
	api: 'db',
	method: 'GET',
	callback: function(req, res) {
		parse(req, res, get);
	}
},
{
	api: 'db',
	method: 'POST',
	callback: function(req, res) {
		parse(req, res, post);
	}
},
{
	api: 'db',
	method: 'PUT',
	callback: function(req, res) {
		parse(req, res, put);
	}
},
{
	api: 'db',
	method: 'DELETE',
	callback: function(req, res) {
		parse(req, res, del);
	}
}
];

function parse(req, res, callback){
	var collection = req.cURL.path[0];
	if (collection === 'users')
	{
		res.end("Not allowed");   // TODO: route to 404 page
		return;
	}
	callback(req, res, collection);
}

function get(req, res, coll) {
	db.collection(coll).find({ "user" : req.user.id}).toArray(function(err, elements){
		if (err) res.end(JSON.stringify(err));
		else
		res.write(JSON.stringify(elements));
		res.end();
	});
}

function post(req, res, coll){
	req.post.user = req.user.id;
	db.collection(coll).insert(req.post, function(err, replies){
		if (err) res.end(JSON.stringify(err));
		else
		res.end(JSON.stringify(replies));
	});
}

function put(req, res, coll){}

function del(req, res, coll){}
